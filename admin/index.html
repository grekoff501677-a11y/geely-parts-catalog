<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Админка каталога Geely</title>
  <style>
    /* Стили для preview карточки товара */
    .product-preview {
      max-width: 400px;
      background: #0f1d2a;
      border: 1px solid #1e3040;
      border-radius: 16px;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      color: #e9f0f7;
    }
    .product-preview .img-wrap {
      position: relative;
      aspect-ratio: 4/3;
      background: #0c1322;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .product-preview .img-wrap img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }
    /* Карусель */
    .carousel-controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 20px;
    }
    .carousel-controls button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .carousel-controls button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .carousel-controls button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .carousel-counter {
      color: white;
      font-size: 13px;
      min-width: 40px;
      text-align: center;
    }
    .product-preview .content {
      padding: 16px;
    }
    .product-preview .name {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 8px;
    }
    .product-preview .desc {
      font-size: 14px;
      color: #9fb2c3;
      margin: 0 0 12px;
    }
    .product-preview .price {
      font-size: 24px;
      font-weight: 700;
      color: #aa8643;
      margin: 0 0 8px;
    }
    .product-preview .models {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 0 0 8px;
    }
    .product-preview .model-badge {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      background: #16283a;
      border: 1px solid #1e3040;
    }
    .product-preview .stock {
      font-size: 13px;
      color: #b9c9dc;
    }
    .product-preview .stock.low {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Глобальное состояние для карусели
    let currentImageIndex = 0;
    
    // Регистрируем кастомный preview для товара
    CMS.registerPreviewTemplate('catalog', createClass({
      getInitialState: function() {
        return { imageIndex: 0 };
      },
      
      handlePrevImage: function() {
        this.setState({ imageIndex: Math.max(0, this.state.imageIndex - 1) });
      },
      
      handleNextImage: function(maxIndex) {
        this.setState({ imageIndex: Math.min(maxIndex, this.state.imageIndex + 1) });
      },
      
      render: function() {
        const entry = this.props.entry;
        const items = entry.getIn(['data', 'items']);
        
        // Если открыт конкретный товар из списка
        if (items && items.size > 0) {
          // Берем первый товар (или можно определить какой именно редактируется)
          const product = items.get(0).toJS();
          return this.renderProductCard(product);
        }
        
        return h('div', { className: 'product-preview' },
          h('p', { style: { padding: '20px', textAlign: 'center', color: '#9fb2c3' } }, 
            'Выберите товар для предварительного просмотра')
        );
      },
      
      renderProductCard: function(product) {
        const price = product.price ? 
          new Intl.NumberFormat('ru-RU').format(product.price) + ' ₸' : 
          '—';
        
        const stock = product.stock == null ? 
          'Под заказ' : 
          product.stock + ' шт';
        
        const stockClass = (product.stock != null && product.stock <= 2) ? 
          'stock low' : 
          'stock';
        
        // Собираем все изображения
        const images = [];
        if (product.img) images.push(product.img);
        if (product.imgs && Array.isArray(product.imgs)) {
          product.imgs.forEach(function(imgObj) {
            if (imgObj && imgObj.url) images.push(imgObj.url);
          });
        }
        
        const currentIndex = this.state.imageIndex;
        const currentImage = images[currentIndex] || null;
        const hasMultipleImages = images.length > 1;
        
        return h('div', { className: 'product-preview' },
          h('div', { className: 'img-wrap' },
            currentImage ? 
              h('img', { 
                src: currentImage, 
                alt: product.name,
                key: currentIndex // Важно для правильного обновления
              }) :
              h('div', { style: { color: '#9fb2c3', padding: '20px', textAlign: 'center' } }, 
                'Фото не выбрано'),
            
            // Карусель управления (только если больше 1 фото)
            hasMultipleImages && h('div', { className: 'carousel-controls' },
              h('button', { 
                onClick: this.handlePrevImage.bind(this),
                disabled: currentIndex === 0,
                'aria-label': 'Предыдущее фото'
              }, '‹'),
              h('span', { className: 'carousel-counter' }, 
                (currentIndex + 1) + ' / ' + images.length),
              h('button', { 
                onClick: this.handleNextImage.bind(this, images.length - 1),
                disabled: currentIndex === images.length - 1,
                'aria-label': 'Следующее фото'
              }, '›')
            )
          ),
          h('div', { className: 'content' },
            h('h3', { className: 'name' }, product.name || 'Без названия'),
            product.desc && h('p', { className: 'desc' }, product.desc),
            h('div', { className: 'price' }, price),
            product.models && product.models.length > 0 && 
              h('div', { className: 'models' },
                product.models.map(function(model) {
                  return h('span', { className: 'model-badge', key: model }, model);
                })
              ),
            h('div', { className: stockClass }, stock),
            product.sku && product.sku !== '-' &&
              h('div', { style: { fontSize: '13px', color: '#9fb2c3', marginTop: '8px' } },
                'Артикул: ' + product.sku),
            product.kaspi && 
              h('div', { style: { marginTop: '12px' } },
                h('a', { 
                  href: product.kaspi, 
                  target: '_blank',
                  rel: 'noopener noreferrer',
                  style: { color: '#aa8643', fontSize: '14px', textDecoration: 'none' }
                }, 'Ссылка на Kaspi →')
              )
          )
        );
      }
    }));
    
    // Вспомогательная функция для создания React-like элементов
    function h(tag, props) {
      const children = Array.prototype.slice.call(arguments, 2);
      return CMS.h.apply(null, [tag, props].concat(children));
    }
    
    function createClass(spec) {
      return CMS.createClass(spec);
    }
  </script>
</body>
</html>
