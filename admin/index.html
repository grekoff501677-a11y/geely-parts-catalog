<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Админка каталога Geely</title>
  <style>
    /* Стили для preview карточки товара */
    .product-preview {
      max-width: 400px;
      background: #0f1d2a;
      border: 1px solid #1e3040;
      border-radius: 16px;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      color: #e9f0f7;
    }
    .product-preview .img-wrap {
      aspect-ratio: 4/3;
      background: #0c1322;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .product-preview .img-wrap img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .product-preview .content {
      padding: 16px;
    }
    .product-preview .name {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 8px;
    }
    .product-preview .desc {
      font-size: 14px;
      color: #9fb2c3;
      margin: 0 0 12px;
    }
    .product-preview .price {
      font-size: 24px;
      font-weight: 700;
      color: #aa8643;
      margin: 0 0 8px;
    }
    .product-preview .models {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 0 0 8px;
    }
    .product-preview .model-badge {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      background: #16283a;
      border: 1px solid #1e3040;
    }
    .product-preview .stock {
      font-size: 13px;
      color: #b9c9dc;
    }
    .product-preview .stock.low {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Регистрируем кастомный preview для товара
    CMS.registerPreviewTemplate('catalog', createClass({
      render: function() {
        const entry = this.props.entry;
        const items = entry.getIn(['data', 'items']);
        
        // Если открыт конкретный товар из списка
        if (items && items.size > 0) {
          // Берем первый товар (или можно определить какой именно редактируется)
          const product = items.get(0).toJS();
          return renderProductCard(product);
        }
        
        return h('div', { className: 'product-preview' },
          h('p', { style: { padding: '20px', textAlign: 'center' } }, 
            'Выберите товар для предварительного просмотра')
        );
      }
    }));
    
    // Функция для рендера карточки товара
    function renderProductCard(product) {
      const price = product.price ? 
        new Intl.NumberFormat('ru-RU').format(product.price) + ' ₸' : 
        '—';
      
      const stock = product.stock == null ? 
        'Под заказ' : 
        product.stock + ' шт';
      
      const stockClass = (product.stock != null && product.stock <= 2) ? 
        'stock low' : 
        'stock';
      
      return h('div', { className: 'product-preview' },
        h('div', { className: 'img-wrap' },
          product.img ? 
            h('img', { src: product.img, alt: product.name }) :
            h('div', { style: { color: '#9fb2c3' } }, 'Фото не выбрано')
        ),
        h('div', { className: 'content' },
          h('h3', { className: 'name' }, product.name || 'Без названия'),
          product.desc && h('p', { className: 'desc' }, product.desc),
          h('div', { className: 'price' }, price),
          product.models && product.models.length > 0 && 
            h('div', { className: 'models' },
              product.models.map(function(model) {
                return h('span', { className: 'model-badge', key: model }, model);
              })
            ),
          h('div', { className: stockClass }, stock),
          product.kaspi && 
            h('div', { style: { marginTop: '12px' } },
              h('a', { 
                href: product.kaspi, 
                target: '_blank',
                style: { color: '#aa8643', fontSize: '14px' }
              }, 'Ссылка на Kaspi →')
            )
        )
      );
    }
    
    // Вспомогательная функция для создания React-like элементов
    function h(tag, props, ...children) {
      return CMS.h(tag, props, ...children);
    }
    
    function createClass(spec) {
      return CMS.createClass(spec);
    }
  </script>
</body>
</html>
